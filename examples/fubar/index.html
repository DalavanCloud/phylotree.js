<!DOCTYPE html>
<meta charset="utf-8">
<style>
    body {
        font: 20px sans-serif;
    }
    
    .axis path,
    .axis line {
        fill: none;
        stroke: #000;
        shape-rendering: crispEdges;
    }
    
    .area {
        fill: #ddd;
        stroke: #444;
        stroke-width: 0.5px;
        fill-opacity: 0.33;
    }
    
    .line {
        fill: none;
        stroke: black;
        stroke-width: 0.5px;
    }

    .annotation-line {
        fill: none;
        stroke: #999;
        stroke-width: 2px;
    }

    .annotation-text {
        font: 20px sans-serif;
        text-anchor: middle;
        fill: #999;
    }
    
</style>

<body>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.5/d3.min.js"></script>
    <script>
        var base_line = 20;

        var margin = {
                top: 40,
                right: 20,
                bottom: 3 * base_line,
                left: 2 * base_line
            },
            width = 1500 - margin.left - margin.right,
            height = 600 - margin.top - margin.bottom;

        function plot_some_data(plot_data, title, container, splitter, y_domain, annotator) {
            /* 
                plot_data -- the FUBAR data to plot; generated by load_file 
                title -- the title of the plot
                container -- the DOM element where the SVG with this plot will go
                splitter -- NULL (single color plot/no legend), or an array of the form
                            [ filter function (on codon indices),
                              fill color,
                              stroke color]
                              
                annotator -- NULL (no region annotation), or an array of entries like this
                            [ start_codon, end_codon, y-coordinate, label, label above or below line ]
            */
            
        
            var x = d3.scale.linear()
                .range([0, width]);

            var y = d3.scale.linear()
                .range([height, 0]);

            var xAxis = d3.svg.axis()
                .scale(x)
                .orient("bottom");

            var yAxis = d3.svg.axis()
                .scale(y)
                .orient("left");

            /* step-plot generator*/

            var area = d3.svg.area()
                .x(function(d) {
                    return x(d.codon);
                })
                .y0(function(d) {
                    return y(0);
                })
                .y1(function(d) {
                    return y(d.value);
                }).
            interpolate('step');


            var svg = container.append("svg").style("display", "table-cell")
                .attr("width", width + margin.left + margin.right)
                .attr("height", height + margin.top + margin.bottom)
                .append("g")
                .attr("transform", "translate(" + margin.left + "," + margin.top + ")");
            
            /* set the domain for the codons */

            x.domain(d3.extent(plot_data, function(d) {
                return d.codon;
            })).clamp (true);

            /* set user-specified domain (for beta-alpha), 
               or auto-detect one*/
                
            if (y_domain) {
                y.domain (y_domain).clamp (true);
            } else {
                y.domain(d3.extent(plot_data, function(d) {
                    return d.value;
                }));
            
                var symmetrize = d3.min (y.domain().map (function (d) {return Math.abs (d);}))*1.25;
                y.domain ([-symmetrize,symmetrize]).clamp(true);
            }

            /* determine if the plot needs to be partitioned into regions 
               if so, draw a separate path for each block
            */

            if (splitter) {
            
                splitter.forEach(function(d) {
                    svg.append("path").datum(plot_data.filter(d[0]))
                        .attr("class", "area")
                        .attr("d", area)
                        .style("fill", d[1])
                        .style("stroke", d[2]);
                    
                });
            } else {
                svg.append("path")
                    .datum(plot_data)
                    .attr("class", "area")
                    .attr("d", area);
            }

            /* for points that have posterior probability of 0.95 or greater, 
               plot a circle on the x-axis 
            */    
            
            plot_data.forEach (function (d) {
                if (d.pp >= 0.95) {
                    svg.append ("circle").attr ("cx", x(d.codon)).attr ("cy", y(0)).attr ("r", "5");
                }
            });

 
            /* handle annotation is provided
            */
            
            if (annotator) {
                annotator.forEach(function(d) {
                    svg.append("line")
                        .attr("class", "annotation-line")
                        .attr("x1", x(d[0]))
                        .attr("x2", x(d[1]))
                        .attr("y1", y(d[2]))
                        .attr("y2", y(d[2]));

                    for (i = 0; i < 2; i++) {
                        svg.append("line")
                            .attr("class", "annotation-line")
                            .attr("x1", x(d[i]))
                            .attr("x2", x(d[i]))
                            .attr("y1", y(d[2])-5)
                            .attr("y2", y(d[2])+5);
                    }
                        
                    svg.append ("text")
                        .attr("class", "annotation-text")
                        .attr("x", x(d[4]))
                        .attr("y", y(d[2]))
                        .attr("dy", d[5] ? "1.25em" : "-0.5em")
                        .text (d[3]);
                    
                });            
            }
           
             /* x-axis */
            svg.append("g")
                .attr("class", "x axis")
                .attr("transform", "translate(0," + height + ")")
                .call(xAxis)
                .append("text")
                .attr("x", width)
                .attr("dy", "+2.5em")
                .style("text-anchor", "end")
                .text("Codon");
                
            

           /* y-axis*/
            svg.append("g")
                .attr("class", "y axis")
                .call(yAxis)
                .append("text")
                .attr("transform", "rotate(-90)")
                .attr("y", 6)
                .attr("dy", ".71em")
                .style("text-anchor", "end")
                .text("\u03B2-\u03B1"); // beta - alpha

            /* plot title */
            if (title) {
                svg.append("text").text(title).style("font-size", "24px").attr("dx", "2em").attr("dy", "-0.1em");
            }
        }

        function load_file(list, index) {
            d3.csv(list[index][0], function(error, data) {
                if (error) throw error;

                var data_to_plot = [];
                var container_div = d3.select("body").append("div");


                fubar_info = [];

                data_to_plot.push([list[index][0], data.map(function(d) {
                    return {
                        "codon": +d["Codon"],
                        "value": +d["beta-alpha"],
                        "pp": +d["Prob[alpha<beta]"]
                    };
                })]);


                data_to_plot.forEach(function(d) {
                    plot_some_data(d[1], list[index][1], container_div, list[index][2], list[index][3], list[index][4]);
                });

                if (index + 1 < list.length) {
                    load_file(list, index + 1);
                }

            });
        }

        /* the first argument to load_file is an array with the following entries (arrays themselves)
            [ 
              URL for the file,
              label for the plot (can be null),
              plot splitter      (see plot_some_data),
              y-axis range       (can be null to auto-detect),
              annotator          (see plot_some_data, can be null)
            ]
        */
        
        load_file([
            ["hev_g134.fas.fubar.csv", "Full genome", [
                [function(d) {
                    return d.codon < 708;
                }, "#1f77b4", "#1f77b4"],
                [function(d) {
                    return d.codon >= 708 && d.codon < 898;
                }, "#d62728", "#d62728"],
                [function(d) {
                    return d.codon > 898 && d.codon < 1815;
                }, "#1f77b4", "#1f77b4"],
                 [function(d) {
                    return d.codon >= 1815 + 108;
                }, "#ff7f0e", "#ff7f0e"],
                [function(d) {
                    return d.codon >= 1815 && d.codon < 1815 + 108;
                }, "#2ca02c", "#2ca02c"]
            ],[-6,6], 
            [[1,1815,4,"ORF1",100,false],
             [708,898,-4,"HVR", (898+708)/2, true],
             [1815,10000,-4,"ORF2", 2000, true],
             [1815,1923,3,"ORF2/ORF3 overlap", 1869, false]
             ]
            ],
            ["g134_orf2overlap.fas.fubar.csv", "OFR2 overlap", null, [-6,6], null],
            ["g134_orf3overlap.fas.fubar.csv", "OFR3 overlap", null, [-6,6], null]
        ], 0);

        //d3.json("coverages-csf.json", function(error, data) {
    </script>